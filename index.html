
<script src="script.js"></script>
<script id="title" type="text/plain">Ray Tracer</script>
<script id="description" type="text/plain">Reflection, transformed objects, fog...</script>
<script id="shader" type="x-shader/x-fragment">

bool DEBUG = true;

vec3 BLACK = vec3(0., 0., 0.);
vec3 RED   = vec3(1.0, 0., 0.);
vec3 GREEN = vec3(0., 1.0, 0.);
vec3 BLUE  = vec3(0., 0., 1.0);

vec3 AMBIENT_LIGHT_COLOR = vec3(0.5, 0.1, 0.3);
const float AMBIENT_LIGHT_FACTOR = 0.1;

const float HALF_FOG_AT = 15.0;
const float ALL_FOG_AT = 9.0 * HALF_FOG_AT;
vec3 FOG_COLOR = vec3(0.1, 0.1, 0.12);

const int HIT = 10;
const int MISSED = 11;

//----------------------------------------------------------------------

const float FL = 1.0;  // focal length
const float AR = 1.0;  // aspect ratio: width / height
vec4 CAM_LOC = vec4(0., 0., FL, 1.);
vec4 CAM_DIR = normalize(vec4(0., 0., 0., 1.) - CAM_LOC);

vec4 moveOutside(vec4 loc, vec4 dir) { return loc + 0.0005 * dir; }

////////////////////////////////////////////////////////////////////////

struct ball {
    vec2 c;
    float r;
};

ball b1 = ball(vec2(uMouseLocation.x / 780., 0.5), 0.1);
ball b2 = ball(vec2(0.7, 0.5), 0.2);

float intersectMetaBall(vec2 p, ball b, float spread_factor) {
    float r = length(p - b.c) / b.r / spread_factor;

    float influence = 0.;

    if( r < 1. / 3. )
        influence = 1. - 3. * r * r;
    else if( r < 1. )
        influence = 1.5 * (1. - r) * (1. - r);

    return influence;
}

vec3 ballColor = vec3(0.2, 0.2, 0.7);

////////////////////////////////////////////////////////////////////////

vec3 computeColor(vec2 p) {

    vec3 color = vec3(p.x / 2., p.y / 2., 0.);

    float inf1 = intersectMetaBall(p, b1, 1.) * 2.0;
    float inf2 = intersectMetaBall(p, b2, 1.) * 3.5;

    float influence = inf1 + inf2 - 0.05;
    if( pow(influence, 0.5) > 0.5 )
        color = RED; //influence * ballColor + (1. - influence) * color;

    return color;
}

////////////////////////////////////////////////////////////////////////

void main(void) {

    float screenX = vUV.x;
    float screenY = vUV.y;
    float time = uTime;
    
    if( DEBUG && screenX < 0.1 && screenY < 0.1 ) {  // for DEBUG
        screenX = uMouseLocation.x / 780.;
        screenY = uMouseLocation.y / 780.;
    }

    vec2 p = vec2(screenX, screenY);

    vec3 color = computeColor(p);

    gl_FragColor = vec4(color, 1.0);
}

</script>

<script>start()</script>
